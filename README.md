## Consent Handling Prototype
An investigative  prototype for consent handling using an ethereum blockchain based on PoA, a web server (express on node) and a mongo database.

It is in no way complete and there is no claim of it ever being completed. It is focusing on the process of handling consents on a blockchain and to learn the functionality, pros and cons of a blockchain supporting this use case.

**This is work in progress, but it is fully functional and allows you to create users, administrators, consent templates, consenst and accept or deny them.**

**For contact, feel free to contact med at tomas.stenlund@telia.com**

## What is a consent?
**When one person voluntarily agrees to the proposal or desires of another.**

This is a common use case when a company wants to perform processing of information collected from a person for a specific purpouse. For example: If a company collects data on a persons usage of a product with the intention of using that data to perform product improvements based on that data, the company needs to have a consent.

## User stories

From a company perspective:
- As a company I would like to be able to have a set of consent templates that I can generate new consent forms from to offer our end users.
- As a company I expect the consent template to specify a purpouse, title and a body describing the purpouse of the consent.
- As a company I would like to generate a new consent form for a specific user from a consent template based on my purpouse.
- As a company I expect the system to choose the consent template when generating the consent form based on my purpouse, the users language and country.
- As a company I would like to determine if a user has accepted or denied a consent.
- As a company I need to be able to provide a detailed audit trail of the consent handling for a specific user when requested.
- As a company I expect the system to automatically generate new consents for the users if a consent template with the same purpouse as the initial consent is updated.
- As a company I need to be able to request or withdraw a consent at any time.

From a user perspective:
- As a user I would like to know which consents I have been requested to answer, are withdrawn, accepted, denied or defered.
- As a user I would like to be able to deny or accept a consent at any time.
- As a user I expect that if a consent gets updated the system adds that consent to my consent file as a new offer.

## What does this prototype contains

A set of contracts written in Solidity that gives a web application the possiblity to create users, consents and present to the user a list of offered consents. It also gives the user the ability to accept, deny or defer the consents and for companies to offer or withdraw consents. The consents are generated by a company and added to the users consent file.

The blockchain has four contracts.

![Alt text](doc/model.gif?raw=true "Model")

- ConsentFactory - A contract that is created for a company (handled by an adminstrator) that allows the company to manage consent templates, generate new consents and add them to a users consent file.

- ConsentFile - A file that contains all the consents that have been offered to a specific user by any company.

- Consent - A contract that allows a company to get consents from a specific user and for a specific purpouse. The user can agree, disagree or defer the decision on wether or not to accept it. A company can withdraw a consent. Consents are generated by the ConsentFactory from ConsetTemplates.

- ConsentTemplate - A contract that holds the generic (user agnostic) parts of a consent such as title, textual description, language, country and purpouse of the consent. Consents are generated from ConsentTemplates.

An express web server with a couple of pages to create new users and allow them to manage their consents during login and for administrators to handle consent templates and consent generation for specific users.

A couple of node javascripts and a genesis file to setup the ethereum blockchain and initiate a ConsentFactory and consent templates on the blockchain.

## Installing and running it

You need to have the following installed. I have indicated the version i am currently running. Newer or older might work as well:
- geth - 1.6.5-stable-cf87713d - make sure it is started before running express. Otherwise express will not start.
- node - v7.10.0
- mongo - 2.6.10 - make sure the daemon is started before running express. Otherwise express will not start.

The following directory structure is recommended:

- **whatever/consent** Cloned from this repository on github.
- **whatever/data** Generated by the setup script in the **consent/deployment/local/setup.sh**.
- **whatever/cert** Where you store the pem files for the key and certificate chain. I am using pem format and have the following files **ca.cert.pem, ica.cert.pem, localhost.cert.pem, localhost.key.pem**.

In addition to this you need a certificate chain for the host, intermediate CA, CA and the private key for the host so you can run the express webserver using SSL. Store them in **whatever/cert** directory.

This is for setting up a local private blockchain using PoA. It is a bit tricky mostly because I have not provided any script and hardcoded a lot of values. This is after all a prototype:

1. Clone the repository to your machine and go into the **whatever/consent/deployment/local** directory. The scripts are assuming you are allowed to write to the directory where the git repo is stored, i.e. the **whatever** directory. Run the **./setup.sh** script from the directory. You should now have the **data** directory mentioned above with the blockchain. Generate your first account with geth so you get an account file in the **whatever/data/keystore**, this account is the main account for your blockchain used by the system. Update the **./boot.sh** script to unlock your main account and remember the hash of the account for later use (in puppeth, next bullet).

2. I used puppeth to generate the initial genesis file to make it easier to set up PoA (clique). Use the values I provide if you do not want to change them in all scripts. Run it and use **"PermobilTest"** as network name. Select 2 from the menu and 2 again for a PoA. Use default whenever presented with one. Use the system account hash from bullet 1 as the authority to seal and prefund that account as well. Use network id as 1967 and embed no fun/vanity in the genesis block unless you want to. Save it and open it up in an editor and clean it up. Look at the genesis.json file in the repository for how it should look like when it is cleaned up. Rerun the **./setup.sh** script again and use the genesis file you just created (name it genesis.json and store it in the same location as the repository one, otherwise the **./setup.sh** script will not find it.

3. Go into the solidity directory **whatever/consent/sol** and run **make**. It will generate the bytecode for the contracts.

4. Start up geth by using the **./boot.sh** script in the same directory as the **./setup.sh** script. It will ask for the password for the system ethereum account to be able to start the mining.

5. Go into the **whatever/consent/node/consent** directory and run the following **node ./lib/setup_contract_factory.js http://localhost:8545 &lt;blockhain account password&gt;**. This script will create the first ConsentFactory. Wait for the blockchain to mine it and remember the consent factory hash which will be printed by the script once it is finished.

6. In the **whatever/consent/node/consent** directory create a **config.json** file, used by express, containing the following:

```
{
"web3url": "http://localhost:8545",
"consentFactory": "<Your ConsentFactory hash from bullet 5>",
"privateKey": "/whatever/cert/localhost.key.pem",
"certificate": "/whatever/cert/localhost.cert.pem",
"ica": "/whatever/cert/ica.cert.pem",
"ca": "/whatever/cert/ca.cert.pem"
}
```

Add the hash for the consentFactory with what you got from the setup script and all of the certificates and key locations to your values.

6. Install all node required libraries by running **npm install** in the **whatever/consent/node/consent** directory.

7. Start up the express node server by running **npm start &lt;blochain account password&gt; &lt;private key password&gt;** in the **whatever/consent/node/consent** directory. The web server should start and you can browse into **http://localhost:3080**.

## What more needs to be done/discussed

This is just a few items that needs to be sorted out:
- Is it the right way to go to create an ethereum account for each user? Then they have to pay gas for the accept/deny operation of the consent. Since ethereum do not support 3rd party paying we must transfer funds to the user. Need to discuss good solution.
- How to handle integrity. Wether or not a person has agreed or not is considered personal data and henec cannot be visible on a public blockchain.
- Is PoA the way to go, and if so who is the Authority in this case?
- Identity and proof of identity of the person is needed for a signature.
- Signature, how to handle that on the consents or is it enough as it is, i.e. accepted or denied via contract from the users ethereum account since they need to unlock it?  Don't know enough of ethereum blockchain if some kind of signing can be done or if this is adequat.
- The consent model is that really the way to go? What to put in the blockchain and what to not put there. Maybe only the actual consent is needed? Need disucssion!
